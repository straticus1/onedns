#cloud-config
# adsdnsgo - Cloud Init Configuration for OCI

hostname: ${hostname}
fqdn: ${hostname}.adsdnsgo.local

package_update: true
package_upgrade: true

packages:
  - docker
  - docker-compose
  - git
  - golang
  - jq
  - bind-utils
  - python3
  - python3-pip
  - nginx
  - certbot
  - python3-certbot-nginx

runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker opc

  # Create app directories
  - mkdir -p /opt/adsdnsgo/{bin,config,logs,data}
  - chown -R opc:opc /opt/adsdnsgo

  # Install Go dependencies
  - |
    cat > /opt/adsdnsgo/install.sh << 'EOF'
    #!/bin/bash
    cd /opt/adsdnsgo

    # Clone and build adsdnsgo
    if [ ! -d "src" ]; then
      git clone https://github.com/straticus1/adsdnsgo.git src
    fi

    cd src
    go mod init adsdnsgo 2>/dev/null || true
    go mod tidy
    go build -o /opt/adsdnsgo/bin/dnsgo ./cmd/adsdnsgo 2>/dev/null || echo "Build will complete on first deploy"

    echo "adsdnsgo installation prepared"
    EOF
    chmod +x /opt/adsdnsgo/install.sh

  # Setup systemd service
  - |
    cat > /etc/systemd/system/adsdnsgo-api.service << 'EOF'
    [Unit]
    Description=adsdnsgo DNS API Service
    After=network.target docker.service
    Wants=docker.service

    [Service]
    Type=simple
    User=opc
    WorkingDirectory=/opt/adsdnsgo
    ExecStart=/opt/adsdnsgo/bin/dnsgo-api serve --port 5000
    Restart=always
    RestartSec=10
    Environment=ADSDNSGO_CONFIG=/opt/adsdnsgo/config/config.json
    Environment=ADSDNSGO_LOG_LEVEL=info

    [Install]
    WantedBy=multi-user.target
    EOF
    systemctl daemon-reload

  # Configure firewall
  - firewall-cmd --permanent --add-port=80/tcp
  - firewall-cmd --permanent --add-port=443/tcp
  - firewall-cmd --permanent --add-port=5000/tcp
  - firewall-cmd --reload

  # Create default config
  - |
    cat > /opt/adsdnsgo/config/config.json << 'EOF'
    {
      "version": "1.0",
      "defaults": {
        "output_level": "long",
        "color": true,
        "timeout": "10s",
        "retries": 3
      },
      "resolvers": {
        "default": ["8.8.8.8", "1.1.1.1"],
        "dnssec_validation": ["9.9.9.9"]
      },
      "api": {
        "enabled": true,
        "port": 5000,
        "rate_limit": {
          "requests_per_minute": 60,
          "requests_per_hour": 1000
        }
      },
      "dnsscience": {
        "enabled": false,
        "endpoint": "https://api.dnsscience.io"
      }
    }
    EOF
    chown opc:opc /opt/adsdnsgo/config/config.json

  # Setup nginx reverse proxy
  - |
    cat > /etc/nginx/conf.d/adsdnsgo.conf << 'EOF'
    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://127.0.0.1:5000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location /health {
            proxy_pass http://127.0.0.1:5000/health;
        }
    }
    EOF
    systemctl enable nginx
    systemctl start nginx

final_message: "adsdnsgo server ready - IP: $PUBLIC_IPV4"
